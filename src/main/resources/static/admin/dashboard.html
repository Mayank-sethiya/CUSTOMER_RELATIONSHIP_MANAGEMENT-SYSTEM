<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - TrackForce CRM</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* General Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #764ba2 0%, #4a0361 100%);
            color: #f1f5f9;
            transition: all 0.3s ease;
            min-height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* Live Background Container */
        #particles-js {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(135deg, rgba(74, 3, 97, 0.9) 0%, rgba(12, 13, 163, 0.62) 100%);
        }

        /* Define CSS Variables for theming */
        :root {
            --primary: #8a2be2;
            --primary-light: #9932cc;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border: rgba(99, 102, 241, 0.3);
            --shadow: rgba(0, 0, 0, 0.4);
            --sidebar-bg: rgba(28, 36, 55, 0.95);
            --card-bg: rgba(28, 36, 55, 0.9);
            --sidebar-text: #e2e8f0;
            --sidebar-text-secondary: #a0aec0;
            --hover-bg: rgba(138, 43, 226, 0.15);
            --button-hover-shadow: rgba(138, 43, 226, 0.5);
            --header-bg-start: rgba(28, 36, 55, 0.95);
            --header-bg-end: rgba(15, 20, 30, 0.95);
            --spacing-large: 30px;
            --spacing-medium: 20px;
            --spacing-small: 10px;
            --sidebar-width-expanded: 260px;
            --sidebar-width-collapsed: 80px;
            --sidebar-padding-expanded: 25px;
        }

        body[data-theme="light"] {
            --primary: #6a0dad;
            --primary-light: #8a2be2;
            --text-primary: #2d3748;
            --text-secondary: #4a5568;
            --border: rgba(160, 174, 192, 0.5);
            --shadow: rgba(0, 0, 0, 0.15);
            --sidebar-bg: rgba(255, 255, 255, 0.98);
            --card-bg: rgba(247, 250, 252, 0.95);
            --sidebar-text: #2d3748;
            --sidebar-text-secondary: #718096;
            --hover-bg: rgba(106, 13, 173, 0.1);
            --button-hover-shadow: rgba(106, 13, 173, 0.3);
            --header-bg-start: rgba(255, 255, 255, 0.95);
            --header-bg-end: rgba(240, 244, 247, 0.95);
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--sidebar-bg);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-light);
            border-radius: 4px;
            border: 2px solid var(--sidebar-bg);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* Header Styles */
        .header {
            background: linear-gradient(90deg, var(--header-bg-start), var(--header-bg-end));
            backdrop-filter: blur(8px);
            padding: var(--spacing-small) var(--spacing-large);
            min-height: 65px;
            box-shadow: 0 4px 25px var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--border);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-medium);
        }

        .back-button, .theme-toggle, .sidebar-toggle {
            background: rgba(138, 43, 226, 0.2);
            color: var(--primary);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        /* Shining effect for buttons */
        .back-button::before, .theme-toggle::before, .sidebar-toggle::before, .logout-btn::before, .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: none;
        }

        .back-button:hover::before, .theme-toggle:hover::before, .sidebar-toggle:hover::before, .logout-btn:hover::before, .action-btn:hover::before {
            animation: shine 0.8s forwards;
        }

        @keyframes shine {
            to {
                left: 100%;
            }
        }

        .back-button:hover, .theme-toggle:hover, .sidebar-toggle:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px var(--button-hover-shadow);
        }

        .admin-welcome {
            font-size: 48px;
            font-weight: 700;
            color: var(--text-primary);
            display: inline-block;
            position: relative;
            transform: translateY(100%);
            opacity: 0;
        }

        /* Improved 3D Flip-in Animation */
        @keyframes subtle-flip-in {
            0% {
                transform: translateY(100%) rotateX(-80deg);
                opacity: 0;
                transform-origin: bottom center;
            }
            100% {
                transform: translateY(0) rotateX(0);
                opacity: 1;
                transform-origin: bottom center;
            }
        }

        /* Gradient Color Animation and settle to white */
        @keyframes gradient-fill-and-stay-white {
            0% {
                background-position: 0% 50%;
                color: transparent;
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                opacity: 1;
                background-image: linear-gradient(to right, #FF00FF, #00FFFF, #FF00FF);
                background-size: 200% auto;
            }
            99% {
                background-position: 100% 50%;
                color: transparent;
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                opacity: 1;
                background-image: linear-gradient(to right, #FF00FF, #00FFFF, #FF00FF);
                background-size: 200% auto;
            }
            100% {
                color: var(--text-primary);
                opacity: 1;
                -webkit-background-clip: unset;
                -webkit-text-fill-color: unset;
                background-color: transparent;
                background-image: none;
            }
        }

        .admin-welcome.animate {
            animation:
                    subtle-flip-in 1.2s cubic-bezier(0.19, 1, 0.22, 1) forwards,
                    gradient-fill-and-stay-white 2s ease-in-out forwards;
            background: linear-gradient(to right, #FF00FF, #00FFFF, #FF00FF);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-medium);
        }

        .logout-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            padding: 10px 22px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        .logout-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.5);
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width-expanded);
            background: var(--sidebar-bg);
            backdrop-filter: blur(8px);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            padding-top: 80px;
            box-shadow: 3px 0 25px var(--shadow);
            z-index: 900;
            transition: all 0.3s ease;
            overflow-y: auto;
            border-right: 1px solid var(--border);
        }

        .sidebar.collapsed {
            width: var(--sidebar-width-collapsed);
        }

        .sidebar.collapsed .sidebar-header {
            padding: 20px 10px;
        }
        .sidebar.collapsed .sidebar-title,
        .sidebar.collapsed .sidebar-subtitle,
        .sidebar.collapsed .nav-section-title {
            display: none;
        }

        .sidebar.collapsed .nav-item {
            justify-content: center;
            padding: 15px 0;
        }
        .sidebar.collapsed .nav-item span {
            display: none;
        }
        .sidebar.collapsed .nav-item i {
            margin: 0;
        }


        .sidebar-header {
            padding: var(--sidebar-padding-expanded);
            text-align: center;
            border-bottom: 1px solid var(--border);
            margin-bottom: var(--spacing-medium);
        }

        .sidebar-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--sidebar-text);
            margin-bottom: 6px;
        }

        .sidebar-subtitle {
            font-size: 14px;
            color: var(--sidebar-text-secondary);
        }

        .sidebar-nav {
            padding: 0;
        }

        .nav-section {
            margin-bottom: var(--spacing-medium);
        }

        .nav-section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--sidebar-text-secondary);
            padding: 0 var(--sidebar-padding-expanded);
            margin-bottom: var(--spacing-small);
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 14px var(--sidebar-padding-expanded);
            color: var(--sidebar-text);
            text-decoration: none;
            transition: all 0.3s ease;
            border-radius: 10px;
            border: none;
            background: transparent;
            cursor: pointer;
            width: 100%;
            text-align: left;
            font-size: 15px;
            font-weight: 500;
        }

        .nav-item:hover,
        .nav-item.active {
            background: var(--hover-bg);
            color: var(--primary);
            transform: translateX(8px);
        }

        .nav-item i {
            font-size: 20px;
            width: 28px;
        }

        /* Main Container Styles */
        .main-container {
            margin-left: var(--sidebar-width-expanded);
            padding: calc(65px + var(--spacing-large)) var(--spacing-large) var(--spacing-large);
            transition: margin-left 0.3s ease;
            overflow-y: auto;
            height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* Main container when sidebar is collapsed */
        .main-container.shifted {
            margin-left: var(--sidebar-width-collapsed);
        }

        /* Welcome Section Styles */
        .welcome-section {
            background: var(--card-bg);
            border-radius: 20px;
            padding: var(--spacing-large);
            box-shadow: 0 8px 30px var(--shadow);
            border: 1px solid var(--border);
            margin-bottom: var(--spacing-large);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .welcome-content {
            width: 100%;
            margin-bottom: var(--spacing-medium);
            text-align: left; /* Aligns heading and subtitle to the left on desktop */
        }

        /* New: Wrapper for animation and stats */
        .animation-and-stats-wrapper {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-start;
            gap: var(--spacing-medium);
            width: 100%;
            margin-bottom: var(--spacing-large);
        }

        .welcome-animation {
            width: 250px;
            height: 250px;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }

        .welcome-animation lottie-player {
            width: 100%;
            height: 100%;
        }

        .welcome-title {
            font-size: 36px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--spacing-small);
        }

        .welcome-subtitle {
            font-size: 17px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .welcome-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            flex-grow: 1;
            gap: var(--spacing-medium);
        }

        /* Colorful Stat Cards with Side Colors */
        .stat-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: var(--spacing-medium);
            text-align: center;
            box-shadow: 0 5px 20px var(--shadow);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border);
            backdrop-filter: blur(5px);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 5px;
            transition: all 0.3s ease;
        }

        .stat-card:nth-child(1)::before {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .stat-card:nth-child(2)::before {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .stat-card:nth-child(3)::before {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .stat-card:nth-child(4)::before {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px var(--shadow);
        }

        .stat-card:hover::before {
            width: 8px;
        }

        .stat-number {
            font-size: 30px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .stat-card:nth-child(1) .stat-number {
            color: #e74c3c;
        }

        .stat-card:nth-child(2) .stat-number {
            color: #3498db;
        }

        .stat-card:nth-child(3) .stat-number {
            color: #2ecc71;
        }

        .stat-card:nth-child(4) .stat-number {
            color: #9b59b6;
        }

        .stat-label {
            font-size: 16px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Dashboard-specific styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: var(--spacing-large);
            margin-bottom: var(--spacing-large);
        }

        .dashboard-card {
            background: var(--card-bg);
            border-radius: 18px;
            padding: var(--spacing-large);
            box-shadow: 0 6px 25px var(--shadow);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            margin-bottom: var(--spacing-large);
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px var(--shadow);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-medium);
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-title i {
            color: var(--primary);
            font-size: 22px;
        }

        .chart-container {
            position: relative;
            height: 220px;
            margin-bottom: var(--spacing-medium);
        }

        /* New elevated style for chart container */
        .chart-container.elevated {
            padding: 15px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.05);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        body[data-theme="light"] .chart-container.elevated {
            background: rgba(0, 0, 0, 0.03);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
        }

        /* --- UPDATED RECENT ACTIVITIES STYLES --- */
        .activity-list {
            list-style: none;
            padding: 0;
            max-height: 350px; /* Adjust height as needed */
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 18px;
            padding: 15px 0;
            border-bottom: 1px solid var(--border);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Original and new icon colors */
        .activity-icon.user { background: #3498db; }      /* Blue */
        .activity-icon.lead { background: #2ecc71; }      /* Green */
        .activity-icon.broadcast { background: #f39c12; } /* Orange */
        .activity-icon.task { background: #9b59b6; }      /* Purple */
        .activity-icon.report { background: #1abc9c; }    /* Teal */
        .activity-icon.alert { background: #e74c3c; }     /* Red */


        .activity-content {
            flex: 1;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            min-width: 0;
        }

        .activity-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .activity-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .activity-time {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .activity-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
            flex-shrink: 0;
        }

        .delete-icon {
            cursor: pointer;
            color: #e74c3c;
            font-size: 16px;
            transition: color 0.3s ease, transform 0.3s ease;
        }
        .delete-icon:hover {
            color: #c0392b;
            transform: scale(1.1);
        }

        .activity-status {
            font-size: 13px;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: 500;
        }

        .status-sent { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-failed { background: #f8d7da; color: #721c24; }

        /* --- END OF ACTIVITY STYLES --- */

        .progress-bar {
            width: 100%;
            height: 10px;
            background: var(--border);
            border-radius: 5px;
            overflow: hidden;
            margin: var(--spacing-small) 0;
        }

        .progress-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.3s ease;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: var(--spacing-medium);
            margin-top: var(--spacing-medium);
        }

        .action-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px var(--button-hover-shadow);
            background: var(--primary-light);
        }

        .metric-value {
            font-size: 26px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 15px;
            color: var(--text-secondary);
        }

        .metric-change {
            font-size: 13px;
            font-weight: 500;
            margin-top: 8px;
        }

        .metric-change.positive { color: #2ecc71; }
        .metric-change.negative { color: #e74c3c; }

        .table-container {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--spacing-medium);
        }

        .data-table th,
        .data-table td {
            text-align: left;
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            font-weight: 600;
            color: var(--text-primary);
            background: rgba(138, 43, 226, 0.1);
        }

        .data-table td {
            color: var(--text-secondary);
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 13px;
            font-weight: 500;
        }

        .status-active { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-inactive { background: #f8d7da; color: #721c24; }

        /* Toast Notification Styles */
        .toast {
            position: fixed;
            top: 25px;
            right: 25px;
            padding: 18px 30px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            animation: slideIn 0.4s ease forwards, fadeOut 0.5s ease forwards 2.5s;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .toast.success { background: var(--primary); }
        .toast.warning { background: #f59e0b; }
        .toast.error { background: #ef4444; }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: static;
                padding: 20px;
                box-shadow: none;
                transform: translateX(-100%);
                transition: transform 0.5s ease;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-container {
                margin-left: 0;
                padding: 20px;
                max-height: none;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .quick-actions {
                grid-template-columns: 1fr;
            }

            .header-left {
                gap: 15px;
            }

            .admin-welcome {
                font-size: 28px;
            }

            /* Disable collapsing on small screens if sidebar is static */
            .sidebar.collapsed {
                width: 100%;
            }

            .sidebar.collapsed .sidebar-header,
            .sidebar.collapsed .nav-section-title {
                display: block;
                padding: 30px;
            }

            .sidebar.collapsed .nav-item {
                justify-content: flex-start;
                padding: 12px 30px;
            }

            .sidebar.collapsed .nav-item span {
                display: inline;
            }

            .sidebar.collapsed .nav-item i {
                margin-right: 15px;
            }

            .main-container.shifted {
                margin-left: 0;
            }

            .welcome-section {
                flex-direction: column;
                text-align: center;
            }

            .welcome-content {
                text-align: center;
            }

            .animation-and-stats-wrapper {
                flex-direction: column;
                align-items: center;
            }

            .welcome-animation {
                width: 180px;
                height: 180px;
                margin-left: 0;
                margin-bottom: var(--spacing-medium);
            }

            .welcome-stats {
                grid-template-columns: 1fr; /* Stacks the cards in one column */
            }
        }

        #ai-agent-card .card-title {
            font-size: 20px; /* Adjust if needed */
        }

        #ai-agent-card .welcome-subtitle {
            font-size: 16px;
            margin-bottom: 20px;
        }

        #ai-agent-card #report-output {
            padding: 15px;
            border-radius: 8px;
            background: rgba(0,0,0,0.2);
            min-height: 100px;
            white-space: pre-wrap; /* Allows text to wrap */
            font-family: monospace;
            color: var(--text-secondary);
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s, transform 0.5s;
        }
    </style>
</head>
<body data-theme="dark">

<div id="particles-js"></div>

<div class="header">
    <div class="header-left">
        <button class="sidebar-toggle" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>
        <button class="back-button" onclick="logout()">
            <i class="fas fa-arrow-left"></i>
        </button>
        <div class="header-title-container">
            <span class="sidebar-title">TrackForce CRM</span><br>
            <span class="sidebar-subtitle">Admin Panel</span>
        </div>
    </div>
    <div class="header-right">
        <button class="theme-toggle" onclick="toggleTheme()">
            <i class="fas fa-adjust"></i>
        </button>
        <button class="logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Logout
        </button>
    </div>
</div>

<div class="sidebar">
    <div class="sidebar-header">

    </div>

    <nav class="sidebar-nav">
        <div class="nav-section">
            <div class="nav-section-title">Main</div>
            <button class="nav-item active" onclick="showDashboard(event)">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </button>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Management</div>
            <button class="nav-item" onclick="navigateToPage('user-management.html', event)">
                <i class="fas fa-users"></i>
                <span>User Management</span>
            </button>

            <button class="nav-item" onclick="navigateToPage('contact-management.html', event)">
                <i class="fas fa-address-book"></i>
                <span>Contact Management</span>
            </button>

            <button class="nav-item" onclick="navigateToPage('broadcast-messaging.html', event)">
                <i class="fas fa-broadcast-tower"></i>
                <span>Broadcast Messaging</span>
            </button>
            <button class="nav-item" onclick="navigateToPage('Task-Assign.html', event)">
                <i class="fas fa-tasks"></i>
                <span>Task Assignment</span>
            </button>
            <button class="nav-item" onclick="navigateToPage('View-Reports.html', event)">
                <i class="fas fa-file-alt"></i>
                <span>View Reports</span>
            </button>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Support</div>
            <button class="nav-item" onclick="navigateToPage('Leads.html', event)">
                <i class="fas fa-envelope"></i>
                <span>Leads</span>
            </button>
        </div>
    </nav>
</div>

<div class="main-container">
    <section class="welcome-section">
        <div class="welcome-content">
            <h1 class="welcome-title">
                <span class="admin-welcome" id="adminWelcome"></span>
            </h1>
            <p class="welcome-subtitle">Welcome to the TrackForce CRM Admin Panel. From here you can manage users, monitor analytics, and configure system settings. Use the navigation menu to access different sections of the admin interface.</p>
        </div>

        <div class="animation-and-stats-wrapper">
            <div class="welcome-animation" id="welcomeAnimation">
                <lottie-player
                        src="animations/welcome-animation.json"  background="transparent"
                        speed="1"
                        style="width: 100%; height: 100%;"
                        loop
                        autoplay
                ></lottie-player>
            </div>

            <div class="welcome-stats">
                <div class="stat-card">
                    <div class="stat-number" id="userCount">0</div>
                    <div class="stat-label">Total Users</div>
                </div>

                <div class="stat-card">
                    <div class="stat-number" id="activeUsersCount">0</div>
                    <div class="stat-label">Active Users</div>
                </div>

                <div class="stat-card">
                    <div class="stat-number" id="signupCount">0</div>
                    <div class="stat-label">New Sign-ups<br>(Last 24h)</div>
                </div>

                <div class="stat-card">
                    <div class="stat-number" id="leadCount">0</div>
                    <div class="stat-label">Leads</div>
                </div>
            </div>
        </div>
    </section>

    <div class="dashboard-grid">
        <div class="dashboard-card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-user-plus"></i>
                    Signup Status
                </h3>

            </div>
            <div class="chart-container">
                <canvas id="revenueChart"></canvas>
            </div>
            <div class="metric-value" id="signupThisMonth">0</div>
            <div class="metric-label">New Signups This Month</div>
            <div class="metric-change positive" id="signupChange">↑ 0% from last month</div>
        </div>

        <div class="dashboard-card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-users"></i>
                    User Activity
                </h3>
            </div>
            <div class="chart-container elevated">
                <canvas id="userChart"></canvas>
            </div>
            <div class="metric-value" id="activeUsersToday">0</div>
            <div class="metric-label">Active Users Today</div>
            <div class="metric-change positive" id="activeUserChange">↑ 0% from yesterday</div>
        </div>

        <div class="dashboard-card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-clock"></i>
                    Recent Activities
                </h3>
            </div>
            <ul class="activity-list" id="activityList">
            </ul>
        </div>
    </div>

    <div class="dashboard-card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-bolt"></i>
                Quick Actions
            </h3>
        </div>
        <div class="quick-actions">
            <button class="action-btn" onclick="createUser()">
                <i class="fas fa-user-plus"></i>
                Add User
            </button>
            <button class="action-btn" onclick="sendBroadcast()">
                <i class="fas fa-broadcast-tower"></i>
                Send Broadcast
            </button>
            <button class="action-btn" onclick="exportData()">
                <i class="fas fa-download"></i>
                Export Data
            </button>
            <button class="action-btn" onclick="generateReport()">
                <i class="fas fa-file-pdf"></i>
                Generate Report
            </button>
        </div>
    </div>
    <div class="dashboard-card" id="ai-agent-card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-robot"></i> AI-Powered Reports
            </h3>
        </div>
        <p class="welcome-subtitle">
            Ask for a summarized report in plain language. Try "How many new leads this month?" or "Summarize task status for all users."
        </p>
        <div style="display: flex; gap: 10px; margin-top: 20px; margin-bottom: 20px;">
            <input type="text" id="report-prompt" placeholder="Enter your report request..." style="flex-grow: 1; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--text-primary); font-size: 15px;">
            <button class="action-btn" id="generate-ai-report-btn">
                <i class="fas fa-paper-plane"></i> Generate
            </button>
        </div>
        <div id="report-output" style="opacity: 1; transform: translateY(0);">
            Your generated report will appear here...
        </div>
    </div>

    <div class="dashboard-card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-table"></i>
                Recent Users
            </h3>
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Status</th>
                    <th>Last Login</th>
                </tr>
                </thead>
                <tbody id="recentUsersTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="toast success">Success message here</div>
<div class="toast warning">Warning message here</div>
<div class="toast error">Error message here</div>

<script src="js/particles.min.js"></script>
<script src="js/lottie-player.js"></script>
<script src="../config.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- Initialize based on localStorage ---
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.body.setAttribute('data-theme', savedTheme);
            initParticles(savedTheme);
        } else {
            initParticles('dark');
        }

        const savedSidebarState = localStorage.getItem('sidebarCollapsed');
        const sidebar = document.querySelector('.sidebar');
        const mainContainer = document.querySelector('.main-container');
        if (savedSidebarState === 'true') {
            sidebar.classList.add('collapsed');
            mainContainer.classList.add('shifted');
        }

        // --- Initialize dashboard components ---
        const dashboardNavItem = document.querySelector('.nav-item.active');
        if (dashboardNavItem) {
            dashboardNavItem.classList.remove('active');
        }
        document.querySelector('.nav-item').classList.add('active');

        updateDashboardData();
        loadRecentActivities();
        loadRecentUsers();

        document.getElementById('generate-ai-report-btn').addEventListener('click', generateAiReport);
    });

    // Function to initialize Particles.js
    function initParticles(theme) {
        if (window.pJSDom && window.pJSDom[0]) {
            window.pJSDom[0].pJS.fn.vendors.destroypJS();
            window.pJSDom = [];
        }
        const particleColor = theme === 'dark' ? "#ffffff" : "#333333";
        particlesJS('particles-js', { particles: { number: { value: 80, density: { enable: true, value_area: 800 } }, color: { value: particleColor }, shape: { type: "circle" }, opacity: { value: 0.5, random: true }, size: { value: 3, random: true }, line_linked: { enable: true, distance: 150, color: particleColor, opacity: 0.4, width: 1 }, move: { enable: true, speed: 2, direction: "none", random: false, straight: false, out_mode: "out", bounce: false } }, interactivity: { detect_on: "canvas", events: { onhover: { enable: true, mode: "grab" }, onclick: { enable: true, mode: "push" }, resize: true }, modes: { grab: { distance: 140, line_linked: { opacity: 1 } }, push: { particles_nb: 4 } } }, retina_detect: true });
    }

    // Theme toggle function
    function toggleTheme() {
        const body = document.body;
        const currentTheme = body.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        body.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        initParticles(newTheme);
        updateDashboardData();
    }

    // Sidebar toggle function
    function toggleSidebar() {
        const sidebar = document.querySelector('.sidebar');
        const mainContainer = document.querySelector('.main-container');
        sidebar.classList.toggle('collapsed');
        mainContainer.classList.toggle('shifted');
        localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
    }

    // Logout function
    function logout() {
        localStorage.removeItem('adminName');
        localStorage.removeItem('theme');
        localStorage.removeItem('sidebarCollapsed');
        window.location.href = '../index.html';
    }

    function showDashboard(event) {
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        if (event && event.currentTarget) {
            event.currentTarget.classList.add('active');
        } else {
            document.querySelector('.nav-item').classList.add('active');
        }
    }

    function navigateToPage(url, event) {
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        if (event && event.currentTarget) {
            event.currentTarget.classList.add('active');
        }
        window.location.href = url;
    }

    function showToast(message, type = 'success') {
        const toast = document.querySelector(`.toast.${type}`);
        if (!toast) return;
        toast.textContent = message;
        toast.style.display = 'block';
        toast.style.animation = 'none';
        void toast.offsetWidth;
        toast.style.animation = null;
        setTimeout(() => {
            toast.style.display = 'none';
        }, 3000);
    }

    // --- QUICK ACTION FUNCTIONS ---
    function createUser() {
        window.location.href = 'user-management.html';
    }

    function sendBroadcast() {
        window.location.href = 'broadcast-messaging.html';
    }

    function exportData() {
        console.log("Exporting Recent Users data...");
        const table = document.querySelector(".data-table");
        if (!table) {
            console.error("Data table not found for export.");
            return;
        }
        let csvContent = "data:text/csv;charset=utf-8,";
        const rows = table.querySelectorAll("tr");
        rows.forEach(row => {
            const rowData = [];
            const cells = row.querySelectorAll("th, td");
            cells.forEach(cell => {
                rowData.push(`"${cell.innerText.replace(/"/g, '""')}"`);
            });
            csvContent += rowData.join(",") + "\r\n";
        });
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "recent_users_export.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    async function generateReport() {
        const reportButton = document.querySelector('button[onclick="generateReport()"]');
        const originalButtonText = reportButton.innerHTML;
        reportButton.disabled = true;
        reportButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Preparing Report...`;
        const originalTheme = document.body.getAttribute('data-theme');
        try {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            document.body.setAttribute('data-theme', 'dark');
            await updateDashboardData();
            await new Promise(resolve => setTimeout(resolve, 500));
            const revenueChartContainer = document.querySelector('#revenueChart').parentElement;
            const userChartContainer = document.querySelector('#userChart').parentElement;
            const [revenueCanvas, userCanvas] = await Promise.all([
                html2canvas(revenueChartContainer, { useCORS: true, backgroundColor: '#1c2437' }),
                html2canvas(userChartContainer, { useCORS: true, backgroundColor: '#1c2437' })
            ]);
            const revenueChartImg = revenueCanvas.toDataURL('image/png', 1.0);
            const userChartImg = userCanvas.toDataURL('image/png', 1.0);
            const [usersRes, tasksRes, leadsRes] = await Promise.all([
                fetch(`${USER_API}`),
                fetch(`${TASK_API}/all`),
                fetch(`${CONTACT_API}`)
            ]);
            if (!usersRes.ok || !tasksRes.ok || !leadsRes.ok) {
                throw new Error('Failed to fetch all data for the report.');
            }
            const users = await usersRes.json();
            const tasks = await tasksRes.json();
            const leads = await leadsRes.json();
            const today = new Date();
            const formattedDate = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear()}`;
            pdf.setFontSize(22);
            pdf.setTextColor('#2d3748');
            pdf.text('TrackForce CRM Dashboard Report', 105, 20, { align: 'center' });
            pdf.setFontSize(12);
            pdf.setTextColor('#666');
            pdf.text(`Generated on: ${formattedDate}`, 105, 28, { align: 'center' });
            pdf.setFontSize(16);
            pdf.text('Key Metrics', 14, 45);
            pdf.setDrawColor('#8a2be2').line(14, 47, 50, 47);
            pdf.setFontSize(11);
            pdf.setTextColor('#333');
            pdf.text(`- Total Users: ${users.length}`, 16, 55);
            pdf.text(`- Active Users: ${users.filter(u => u.status === 'active').length}`, 16, 61);
            pdf.text(`- Total Leads: ${leads.length}`, 16, 67);
            pdf.text(`- Total Tasks: ${tasks.length}`, 16, 73);
            pdf.addImage(revenueChartImg, 'PNG', 14, 85, 90, 55);
            pdf.addImage(userChartImg, 'PNG', 110, 85, 90, 55);
            pdf.addPage();
            pdf.setFontSize(16);
            pdf.text('User Details', 14, 20);
            pdf.setDrawColor('#8a2be2').line(14, 22, 48, 22);
            const userTableData = users.map(user => [user.id, user.username, user.email, user.status, user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A']);
            pdf.autoTable({ startY: 30, head: [['ID', 'Username', 'Email', 'Status', 'Joined Date']], body: userTableData, theme: 'striped', headStyles: { fillColor: '#6a0dad' } });
            let finalY = pdf.lastAutoTable.finalY || 30;
            if (finalY + 40 > pdf.internal.pageSize.height) {
                pdf.addPage();
                finalY = 0;
            }
            pdf.setFontSize(16);
            pdf.text('Task Status', 14, finalY + 15);
            pdf.setDrawColor('#8a2be2').line(14, finalY + 17, 45, finalY + 17);
            const taskTableData = tasks.map(task => [task.title, task.status, Array.isArray(task.assignedTo) ? task.assignedTo.join(', ') : (task.assignedTo || 'Unassigned'), task.dueDate ? new Date(task.dueDate).toLocaleDateString() : 'N/A']);
            pdf.autoTable({ startY: finalY + 22, head: [['Task Title', 'Status', 'Assigned To', 'Due Date']], body: taskTableData, theme: 'grid', headStyles: { fillColor: '#6a0dad' } });
            pdf.save(`TrackForce_CRM_Report_${formattedDate.replace(/\//g, '-')}.pdf`);
            showToast("Professional report generated successfully!", "success");
        } catch (error) {
            console.error("Error generating data-driven PDF report:", error);
            showToast(`Failed to generate report: ${error.message}`, "error");
        } finally {
            document.body.setAttribute('data-theme', originalTheme);
            await updateDashboardData();
            reportButton.disabled = false;
            reportButton.innerHTML = originalButtonText;
        }
    }

    // --- SUPERCHARGED AI AGENT FUNCTIONS ---

    /**
     * Gathers a wide range of data from all relevant APIs to provide context for the AI.
     * This function is resilient, meaning if one API fails, the others can still succeed.
     */
    async function gatherAppContext() {
        console.log("Gathering comprehensive app context for AI...");

        // Use Promise.allSettled to ensure all requests complete, even if some fail.
        const results = await Promise.allSettled([
            fetch(`${USER_API}`),
            fetch(`${TASK_API}/all`),
            fetch(`${CONTACT_API}`),
            fetch(`${BROADCAST_API}/all`),
            fetch(`${REPORT_API}`),
            // Your own controller names show these stats endpoints already exist!
            fetch(`${TASK_API}/statistics`),
            fetch(`${BROADCAST_API}/pending/count`),
            fetch(`${USER_API}/signups/monthly`)
        ]);

        // Helper function to safely parse JSON from settled promises
        const getJson = async (result) => {
            if (result.status === 'fulfilled' && result.value.ok) {
                const text = await result.value.text();
                try {
                    return JSON.parse(text);
                } catch (e) {
                    return text; // Return as text if not valid JSON (for simple counts)
                }
            }
            return null;
        };

        const [
            users,
            tasks,
            contacts,
            broadcasts,
            taskReports,
            taskStats,
            pendingBroadcasts,
            userGrowth
        ] = await Promise.all(results.map(getJson));

        // Sanitize and structure the data for the AI prompt
        const contextData = {
            summaryMetrics: {
                totalUsers: users?.length ?? document.getElementById('userCount').textContent,
                totalContacts: contacts?.length ?? document.getElementById('leadCount').textContent,
                totalTasks: tasks?.length ?? 0,
                totalBroadcasts: broadcasts?.length ?? 0,
                pendingBroadcasts: pendingBroadcasts ?? 0,
                totalTaskReports: taskReports?.length ?? 0,
                taskStatusCounts: taskStats, // Your API provides e.g., { "To Do": 10, "In Progress": 5, "Completed": 25 }
                monthlyUserGrowth: userGrowth // Your API provides { months: [...], counts: [...] }
            },
            users: users?.map(u => ({ username: u.username, email: u.email, status: u.status, createdAt: u.createdAt })) || [],
            tasks: tasks?.map(t => ({ title: t.title, status: t.status, assignedTo: t.assignedTo, priority: t.priority, dueDate: t.dueDate })) || [],
            contacts: contacts?.map(c => ({ name: c.name, email: c.email, status: c.status, createdAt: c.createdAt })) || [],
            broadcasts: broadcasts?.map(b => ({ subject: b.subject, status: b.status, createdAt: b.createdAt })) || [],
            taskReports: taskReports?.map(r => ({ title: r.title, userName: r.userName, createdAt: r.createdAt })) || [],
            currentDate: new Date().toISOString()
        };

        return contextData;
    }

    /**
     * Handles the user's request, gathers context, and calls the AI backend.
     */
    async function generateAiReport() {
        const promptInput = document.getElementById('report-prompt');
        const outputDiv = document.getElementById('report-output');
        const generateBtn = document.getElementById('generate-ai-report-btn');
        const userPrompt = promptInput.value.trim();

        if (!userPrompt) {
            showToast("Please enter a report request.", "warning");
            return;
        }

        const originalButtonHtml = generateBtn.innerHTML;
        generateBtn.disabled = true;
        generateBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Analyzing...`;
        outputDiv.style.opacity = '1';
        outputDiv.style.transform = 'translateY(0)';
        outputDiv.innerText = "Gathering system-wide data for analysis...";

        try {
            // Step 1: Gather the comprehensive app context from all your APIs
            const contextData = await gatherAppContext();

            // Step 2: Send the prompt AND the rich context to the backend
            const response = await fetch(`${AI_REPORT_API}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    prompt: userPrompt,
                    context: contextData
                })
            });

            const data = await response.json();
            if (!response.ok) throw new Error(data.report || 'An unknown error occurred on the server.');
            outputDiv.innerText = data.report;
            showToast("AI Report generated successfully!", "success");

        } catch (error) {
            console.error("Error generating AI report:", error);
            outputDiv.innerText = `An error occurred: ${error.message}\n\nPlease check the backend console for details.`;
            showToast("Failed to generate AI report.", "error");
        } finally {
            generateBtn.disabled = false;
            generateBtn.innerHTML = originalButtonHtml;
        }
    }


    // --- DATA LOADING AND OTHER FUNCTIONS ---
    async function loadRecentActivities() {
        const activityList = document.getElementById('activityList');
        activityList.innerHTML = '<li style="text-align: center; padding: 20px; color: var(--text-secondary);">Loading activities...</li>';

        try {
            const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);

            const [usersRes, tasksRes, reportsRes, broadcastsRes, leadsRes] = await Promise.all([
                fetch(`${USER_API}`),
                fetch(`${TASK_API}/recent`),
                fetch(`${REPORT_API}`),
                fetch(`${BROADCAST_API}/all`),
                fetch(`${CONTACT_API}`)
            ]);

            const [users, tasks, reports, broadcasts, leads] = await Promise.all([
                usersRes && usersRes.ok ? usersRes.json() : [],
                tasksRes && tasksRes.ok ? tasksRes.json() : [],
                reportsRes && reportsRes.ok ? reportsRes.json() : [],
                broadcastsRes && broadcastsRes.ok ? broadcastsRes.json() : [],
                leadsRes && leadsRes.ok ? leadsRes.json() : []
            ]);

            const allActivities = [];

            if (Array.isArray(users)) {
                users
                    .filter(u => new Date(u.createdAt) > oneWeekAgo)
                    .forEach(user => allActivities.push({
                        type: 'user',
                        title: `New User: ${user.username}`,
                        subtitle: user.email,
                        time: user.createdAt
                    }));
            }

            if (Array.isArray(tasks)) {
                tasks.forEach(task => {
                    const assignedToText = Array.isArray(task.assignedTo) ? task.assignedTo.join(', ') : task.assignedTo || 'Unassigned';
                    allActivities.push({
                        type: 'task',
                        title: `Task Assigned: "${task.title}"`,
                        subtitle: `To ${assignedToText}`,
                        time: task.createdAt
                    });
                });
            }

            if (Array.isArray(reports)) {
                reports
                    .filter(r => new Date(r.createdAt) > oneWeekAgo)
                    .forEach(report => allActivities.push({
                        type: 'report',
                        title: `Report Submitted: "${report.title}"`,
                        subtitle: `By ${report.userName}`,
                        time: report.createdAt
                    }));
            }

            if (Array.isArray(broadcasts)) {
                broadcasts.forEach(msg => allActivities.push({
                    type: 'broadcast',
                    title: `Broadcast Sent: "${msg.subject}"`,
                    subtitle: `To ${msg.totalRecipients || 'N/A'} recipients`,
                    time: msg.createdAt,
                    status: msg.status,
                    id: msg.id
                }));
            }

            if(Array.isArray(leads)) {
                leads
                    .filter(lead => new Date(lead.createdAt) > oneWeekAgo)
                    .forEach(lead => allActivities.push({
                        type: 'lead',
                        title: `New Lead: ${lead.name}`,
                        subtitle: `From ${lead.source || 'Unknown'}`,
                        time: lead.createdAt
                    }));
            }

            allActivities.sort((a, b) => new Date(b.time) - new Date(a.time));
            const recentActivities = allActivities.slice(0, 15);

            if (recentActivities.length === 0) {
                activityList.innerHTML = '<li style="text-align: center; padding: 20px; color: var(--text-secondary);">No recent activities.</li>';
                return;
            }

            activityList.innerHTML = '';
            const iconMap = { user: { class: 'user', icon: 'fa-user-plus' }, lead: { class: 'lead', icon: 'fa-address-book' }, broadcast: { class: 'broadcast', icon: 'fa-bullhorn' }, task: { class: 'task', icon: 'fa-tasks' }, report: { class: 'report', icon: 'fa-file-signature' } };
            recentActivities.forEach(activity => {
                const item = document.createElement('li');
                item.className = 'activity-item';
                const { class: iconClass, icon: iconName } = iconMap[activity.type] || { class: 'alert', icon: 'fa-bell' };
                let actionsHTML = '';
                if (activity.type === 'broadcast' && activity.status) {
                    const statusClass = activity.status === "Sent" ? "status-sent" : activity.status === "Pending" ? "status-pending" : "status-failed";
                    actionsHTML += `<span class="activity-status ${statusClass}">${activity.status}</span>`;
                }
                if (activity.type === 'broadcast' && activity.id) {
                    actionsHTML += `<i class="fas fa-trash delete-icon" onclick="deleteMessage(${activity.id})"></i>`;
                }
                item.innerHTML = `
                    <div class="activity-icon ${iconClass}">
                        <i class="fas ${iconName}"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">${activity.title}</div>
                        <div class="activity-subtitle">${activity.subtitle}</div>
                        <div class="activity-time">${formatTimeAgo(activity.time)}</div>
                    </div>
                    <div class="activity-actions">${actionsHTML}</div>
                `;
                activityList.appendChild(item);
            });

        } catch (error) {
            console.error('Error loading activities:', error);
            activityList.innerHTML = `<li style="text-align: center; padding: 20px; color: var(--text-secondary);">Error loading activities.</li>`;
        }
    }

    async function deleteMessage(id) {
        if (confirm('Are you sure you want to delete this broadcast message?')) {
            try {
                const response = await fetch(`${BROADCAST_API}/delete/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    showToast('Broadcast message deleted successfully!');
                    loadRecentActivities();
                } else {
                    const errorData = await response.json();
                    showToast(`Failed to delete message: ${errorData.message || response.statusText}`, 'error');
                }
            }
            catch (error) {
                console.error('Error deleting message:', error);
                showToast(`Error deleting message: ${error.message}`, 'error');
            }
        }
    }

    let signupChartInstance = null;
    let userChartInstance = null;

    async function initializeCharts(users, totalLeadsCount, signupsMonthlyData, activeUsersCount) {
        try {
            const isDarkMode = document.body.getAttribute('data-theme') === 'dark';
            const chartFontColor = isDarkMode ? '#f1f5f9' : '#2d3748';
            const gridLineColor = isDarkMode ? 'rgba(241, 245, 249, 0.1)' : 'rgba(45, 55, 72, 0.1)';
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            if (signupChartInstance) signupChartInstance.destroy();
            signupChartInstance = new Chart(revenueCtx, {
                type: 'line', data: { labels: signupsMonthlyData.months, datasets: [{ label: 'Monthly Signups', data: signupsMonthlyData.counts, borderColor: '#3498db', backgroundColor: 'rgba(52, 152, 219, 0.1)', tension: 0.4, fill: true }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false, labels: { color: chartFontColor } }, tooltip: { bodyColor: chartFontColor, titleColor: chartFontColor } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Number of Signups', color: chartFontColor }, grid: { color: gridLineColor }, ticks: { color: chartFontColor } }, x: { title: { display: true, text: 'Month', color: chartFontColor }, grid: { color: gridLineColor }, ticks: { color: chartFontColor } } } }
            });

            const currentSignups = signupsMonthlyData.counts.at(-1) || 0;
            const previousSignups = signupsMonthlyData.counts.at(-2) || 1;
            const changePercentSignups = (((currentSignups - previousSignups) / previousSignups) * 100).toFixed(1);
            document.getElementById("signupThisMonth").textContent = currentSignups;
            const signupChangeElem = document.getElementById("signupChange");
            signupChangeElem.textContent = `${changePercentSignups >= 0 ? '↑' : '↓'} ${Math.abs(changePercentSignups)}% from last month`;
            signupChangeElem.className = `metric-change ${changePercentSignups >= 0 ? 'positive' : 'negative'}`;

            const inactiveUsers = users.filter(u => u.status === 'inactive').length;
            const userCtx = document.getElementById('userChart').getContext('2d');
            if (userChartInstance) userChartInstance.destroy();
            userChartInstance = new Chart(userCtx, {
                type: 'doughnut',
                data: { labels: ['Active Users', 'Leads', 'Inactive Users'], datasets: [{ data: [activeUsersCount, totalLeadsCount, inactiveUsers], backgroundColor: ['#2ecc71', '#f39c12', '#e74c3c'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: chartFontColor, usePointStyle: true, padding: 15 } }, tooltip: { bodyColor: chartFontColor, titleColor: chartFontColor } }, elements: { arc: { borderColor: isDarkMode ? 'rgba(28, 36, 55, 0.9)' : 'rgba(247, 250, 252, 0.95)' } } }
            });

            document.getElementById("activeUsersToday").textContent = activeUsersCount;
            const activeUserChangeElem = document.getElementById("activeUserChange");
            if (activeUsersCount > 0) {
                activeUserChangeElem.textContent = '↑ 100% from yesterday';
                activeUserChangeElem.className = 'metric-change positive';
            } else {
                activeUserChangeElem.textContent = '↑ 0% from yesterday';
                activeUserChangeElem.className = 'metric-change positive';
            }
        } catch (error) {
            console.error('Error initializing charts:', error);
        }
    }

    async function updateDashboardData() {
        try {
            const [usersRes, leadsRes, signupsMonthlyRes, signupsRecentRes] = await Promise.all([
                fetch(`${USER_API}`),
                fetch(`${CONTACT_API}/count`),
                fetch(`${USER_API}/signups/monthly`),
                fetch(`${USER_API}/count/recent`)
            ]);
            if (!usersRes.ok || !leadsRes.ok || !signupsMonthlyRes.ok || !signupsRecentRes.ok) {
                throw new Error('One or more API requests failed');
            }
            const users = await usersRes.json();
            const leadsData = await leadsRes.json();
            const signupsMonthlyData = await signupsMonthlyRes.json();
            const recentSignupsData = await signupsRecentRes.json();
            const totalActiveUsers = users.filter(user => user.status === 'active').length;
            document.getElementById("userCount").textContent = users.length;
            document.getElementById('activeUsersCount').textContent = totalActiveUsers;
            document.getElementById("signupCount").textContent = recentSignupsData.count || 0;
            document.getElementById("leadCount").textContent = leadsData.count !== undefined ? leadsData.count : leadsData;
            initializeCharts(users, leadsData.count !== undefined ? leadsData.count : leadsData, signupsMonthlyData, totalActiveUsers);
            const adminName = localStorage.getItem('adminName') || 'Admin';
            const adminWelcome = document.getElementById('adminWelcome');
            if (adminWelcome.textContent !== `Hi ${adminName}!`) {
                adminWelcome.classList.remove('animate');
                adminWelcome.textContent = `Hi ${adminName}!`;
                void adminWelcome.offsetWidth;
                adminWelcome.classList.add('animate');
            }
        } catch (error) {
            console.error("Error updating dashboard data:", error);
        }
    }

    async function loadRecentUsers() {
        try {
            const response = await fetch(`${USER_API}`);
            if (!response.ok) throw new Error(`Users API error: ${response.statusText}`);
            const users = await response.json();
            users.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            const recent = users.slice(0, 5);
            const tbody = document.getElementById('recentUsersTableBody');
            tbody.innerHTML = '';
            if (recent.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No recent users</td></tr>';
                return;
            }
            recent.forEach(user => {
                const statusClass = user.status === 'active' ? 'status-active' : user.status === 'inactive' ? 'status-inactive' : 'status-pending';
                const row = `<tr><td>${user.username}</td><td>${user.email}</td><td><span class="status-badge ${statusClass}">${user.status}</span></td><td>${formatTimeAgo(user.lastLogin || user.createdAt)}</td></tr>`;
                tbody.innerHTML += row;
            });
        } catch (error) {
            console.error('Error loading recent users:', error);
            document.getElementById('recentUsersTableBody').innerHTML = `<tr><td colspan="4" style="text-align: center;">Error loading users</td></tr>`;
        }
    }

    function formatTimeAgo(dateString) {
        if (!dateString) return 'Never';
        const now = new Date();
        const date = new Date(dateString);
        const diff = now.getTime() - date.getTime();
        const seconds = Math.floor(diff / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);
        const months = Math.floor(days / 30.44);
        const years = Math.floor(days / 365.25);
        if (seconds < 60) return `${seconds}s ago`;
        if (minutes < 60) return `${minutes}m ago`;
        if (hours < 24) return `${hours}h ago`;
        if (days < 30) return `${days}d ago`;
        if (months < 12) return `${months}mo ago`;
        return `${years}y ago`;
    }

    setInterval(function() {
        updateDashboardData();
        loadRecentActivities();
        loadRecentUsers();
    }, 30000); // Refresh all data every 30 seconds
</script>
</body>
</html>