<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Lead Management - TrackForce CRM</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* General Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #764ba2 0%, #4a0361 100%);
            color: #f1f5f9;
            transition: all 0.3s ease;
            min-height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* Live Background Container */
        #particles-js {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(135deg, rgba(74, 3, 97, 0.9) 0%, rgba(12, 13, 163, 0.62) 100%);
        }

        /* Define CSS Variables for theming */
        :root {
            --primary: #8a2be2;
            --primary-light: #9932cc;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border: rgba(99, 102, 241, 0.3);
            --shadow: rgba(0, 0, 0, 0.4);
            --sidebar-bg: rgba(28, 36, 55, 0.95);
            --card-bg: rgba(28, 36, 55, 0.9);
            --sidebar-text: #e2e8f0;
            --sidebar-text-secondary: #a0aec0;
            --hover-bg: rgba(138, 43, 226, 0.15);
            --button-hover-shadow: rgba(138, 43, 226, 0.5);
            --header-bg-start: rgba(28, 36, 55, 0.95);
            --header-bg-end: rgba(15, 20, 30, 0.95);
            --spacing-large: 30px;
            --spacing-medium: 20px;
            --spacing-small: 10px;
            --sidebar-width-expanded: 260px;
            --sidebar-width-collapsed: 80px;
            --sidebar-padding-expanded: 25px;
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --spacing-xl: 20px;
            --header-height: 65px;
            --header-height-mobile: 65px;
            --text-xs: 0.75rem;
            --text-sm: 0.875rem;
            --text-base: 1rem;
            --text-lg: 1.125rem;
            --text-xl: 1.25rem;
            --text-2xl: 1.5rem;
        }

        body[data-theme="light"] {
            --primary: #6a0dad;
            --primary-light: #8a2be2;
            --text-primary: #2d3748;
            --text-secondary: #4a5568;
            --border: rgba(160, 174, 192, 0.5);
            --shadow: rgba(0, 0, 0, 0.15);
            --sidebar-bg: rgba(255, 255, 255, 0.98);
            --card-bg: rgba(247, 250, 252, 0.95);
            --sidebar-text: #2d3748;
            --sidebar-text-secondary: #718096;
            --hover-bg: rgba(106, 13, 173, 0.1);
            --button-hover-shadow: rgba(106, 13, 173, 0.3);
            --header-bg-start: rgba(255, 255, 255, 0.95);
            --header-bg-end: rgba(240, 244, 247, 0.95);
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--sidebar-bg); border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: var(--primary-light); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* Header Styles */
        .header {
            background: linear-gradient(90deg, var(--header-bg-start), var(--header-bg-end));
            backdrop-filter: blur(8px);
            padding: var(--spacing-small) var(--spacing-large);
            min-height: var(--header-height);
            box-shadow: 0 4px 25px var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--border);
        }
        .header-left, .header-right { display: flex; align-items: center; gap: var(--spacing-md); }
        .back-button, .theme-toggle, .sidebar-toggle {
            background: rgba(138, 43, 226, 0.2);
            color: var(--primary);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 20px;
        }
        .logout-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            padding: 10px 22px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .header-title { font-size: var(--text-lg); font-weight: 600; color: var(--text-primary); }
        .header-subtitle { font-size: var(--text-xs); color: var(--text-secondary); display: block; line-height: 1.2; }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width-expanded);
            background: var(--sidebar-bg);
            backdrop-filter: blur(8px);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            padding-top: var(--header-height);
            box-shadow: 3px 0 25px var(--shadow);
            z-index: 900;
            transition: all 0.3s ease;
            overflow-y: auto;
            border-right: 1px solid var(--border);
        }
        .sidebar.collapsed { width: var(--sidebar-width-collapsed); }
        .sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); z-index: 850; opacity: 0;
            visibility: hidden; transition: all 0.3s ease;
        }
        .sidebar-overlay.active { opacity: 1; visibility: visible; }
        .sidebar-nav { padding: 0; }
        .nav-section { margin-bottom: var(--spacing-lg); }
        .nav-section:first-child { padding-top: var(--spacing-lg); }
        .nav-section + .nav-section { border-top: 1px solid var(--border); padding-top: var(--spacing-lg); }
        .nav-section-title {
            font-size: var(--text-xs); font-weight: 600; color: var(--sidebar-text-secondary);
            padding: 0 var(--spacing-lg); margin-bottom: var(--spacing-sm); text-transform: uppercase; letter-spacing: 0.5px;
        }
        .nav-item {
            display: flex; align-items: center; gap: var(--spacing-md); padding: var(--spacing-md) var(--spacing-lg);
            color: var(--sidebar-text); text-decoration: none; transition: all 0.3s ease; border-radius: 8px;
            border: none; background: transparent; cursor: pointer; width: 100%; text-align: left;
            font-size: var(--text-sm); font-weight: 500; margin-bottom: calc(var(--spacing-sm) / 3);
        }
        .nav-item:hover, .nav-item.active { background: var(--hover-bg); color: var(--primary); transform: translateX(4px); }
        .nav-item i { font-size: var(--text-lg); width: 20px; flex-shrink: 0; }
        .sidebar.collapsed .nav-section-title { display: none; }
        .sidebar.collapsed .nav-item { justify-content: center; padding: var(--spacing-md) 0; }
        .sidebar.collapsed .nav-item span { display: none; }
        .sidebar.collapsed .nav-item i { margin: 0; }

        /* Main Content */
        .main-container {
            margin-left: var(--sidebar-width-expanded);
            padding: calc(var(--header-height) + var(--spacing-large)) var(--spacing-large) var(--spacing-large);
            transition: margin-left 0.3s ease;
            overflow-y: auto;
            height: 100vh;
        }
        .main-container.shifted { margin-left: var(--sidebar-width-collapsed); }
        .page-title { font-size: var(--text-2xl); font-weight: 700; color: white; margin-bottom: var(--spacing-large); display: flex; align-items: center; gap: 15px; }
        .page-title i { color: var(--primary); }

        /* Reusable Card Component */
        .card { background: var(--card-bg); border-radius: 18px; padding: var(--spacing-large); box-shadow: 0 6px 25px var(--shadow); border: 1px solid var(--border); backdrop-filter: blur(5px); margin-bottom: var(--spacing-large); }

        /* Page-Specific Styles: Leads */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card-bg); backdrop-filter: blur(10px); border-radius: 15px; padding: 25px; text-align: center; border: 1px solid var(--border); transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); }
        .stat-icon { font-size: 28px; margin-bottom: 15px; }
        .stat-card:nth-child(1) .stat-icon { color: #6366f1; }
        .stat-card:nth-child(2) .stat-icon { color: #10b981; }
        .stat-card:nth-child(3) .stat-icon { color: #f59e0b; }
        .stat-card:nth-child(4) .stat-icon { color: #ef4444; }
        .stat-number { font-size: 32px; font-weight: 700; color: var(--text-primary); }
        .stat-label { font-size: 14px; color: var(--text-secondary); font-weight: 500; }

        .controls-grid { display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 20px; align-items: end; }
        .control-group { display: flex; flex-direction: column; gap: 8px; }
        .control-label { font-size: 14px; font-weight: 600; color: var(--text-primary); }
        .control-input { padding: 12px 16px; border: 1px solid var(--border); border-radius: 10px; background: transparent; color: var(--text-primary); font-size: 14px; }
        .control-input:focus { outline: none; border-color: var(--primary); }
        .control-input option {
            background: var(--sidebar-bg);
            color: var(--text-primary);
        }

        .btn { padding: 12px 24px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; }
        .btn-secondary { background: rgba(138, 43, 226, 0.15); color: var(--primary); }
        .btn-sm { padding: 8px 12px; font-size: 12px; }

        .table-container { background: var(--card-bg); backdrop-filter: blur(10px); border-radius: 15px; overflow: hidden; border: 1px solid var(--border); }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 16px; text-align: left; border-bottom: 1px solid var(--border); color: var(--text-secondary); }
        th { background: rgba(0,0,0,0.2); color: var(--text-primary); }
        td strong { color: var(--text-primary); }
        tr:hover { background: var(--hover-bg); }
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; }
        .status-new { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .status-contacted { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .status-qualified { background: rgba(16, 185, 129, 0.2); color: #10b981; }

        .pagination { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 30px; }
        .pagination button { padding: 10px 15px; border: 1px solid var(--border); background: transparent; color: var(--text-primary); border-radius: 8px; cursor: pointer; }
        .pagination button:hover:not(:disabled) { background: var(--primary); border-color: var(--primary); }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination button.active { background: var(--primary); border-color: var(--primary); color: white; }

        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal.active { display: flex; }
        .modal-content { background: var(--card-bg); max-width: 500px; padding: 30px; border-radius: 15px; color: var(--text-primary); position: relative; border: 1px solid var(--border); }
        .modal-close { position: absolute; top: 15px; right: 15px; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary); }
        .modal-content h2 { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border); }
        .modal-content p { color: var(--text-secondary); line-height: 1.7; margin-bottom: 12px; }
        .modal-content strong { color: var(--text-primary); }

        /* Responsive */
        @media (max-width: 992px) {
            .controls-grid { grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 768px) {
            body { overflow-y: auto; }
            .header { padding: var(--spacing-small) 15px; }
            .header-title-container { display: none; }
            .sidebar {
                width: 280px; transform: translateX(-100%); transition: transform 0.3s ease;
                z-index: 900; padding-top: var(--header-height-mobile);
            }
            .sidebar.mobile-active { transform: translateX(0); }
            .sidebar.collapsed { width: 280px; transform: translateX(-100%); }
            .sidebar.collapsed.mobile-active { transform: translateX(0); }
            .sidebar.collapsed .nav-section-title { display: block; }
            .sidebar.collapsed .nav-item { justify-content: flex-start; padding: 14px var(--sidebar-padding-expanded); }
            .sidebar.collapsed .nav-item span { display: inline; }
            .sidebar.collapsed .nav-item i { margin-right: 15px; width: 28px; }

            .main-container {
                margin-left: 0;
                padding: calc(var(--header-height) + 15px) 15px 15px;
            }
            .main-container.shifted { margin-left: 0; }
            .page-title { font-size: var(--text-xl); }
            .controls-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 480px) {
            .logout-btn span { display: none; }
            .logout-btn { width: 40px; height: 40px; padding: 0; border-radius: 50%; justify-content: center; }
            .back-button, .theme-toggle, .sidebar-toggle { width: 40px; height: 40px; }
            .nav-item { padding: var(--spacing-sm) var(--spacing-md); font-size: var(--text-xs); }
            .nav-item i { font-size: var(--text-sm); width: 16px; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body data-theme="dark">

<div id="particles-js"></div>

<div class="sidebar-overlay" onclick="closeMobileSidebar()"></div>

<div class="header">
    <div class="header-left">
        <button class="sidebar-toggle" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>
        <button class="back-button" onclick="navigateToPage('dashboard.html')">
            <i class="fas fa-arrow-left"></i>
        </button>
        <div class="header-title-container">
            <div class="header-title">TrackForce CRM</div>
            <span class="header-subtitle">Admin Panel</span>
        </div>
    </div>
    <div class="header-right">
        <button class="theme-toggle" onclick="toggleTheme()">
            <i class="fas fa-adjust"></i>
        </button>
        <button class="logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
        </button>
    </div>
</div>

<div class="sidebar collapsed">
    <nav class="sidebar-nav">
        <div class="nav-section">
            <div class="nav-section-title">Main</div>
            <button class="nav-item" onclick="navigateToPage('dashboard.html')">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </button>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">Management</div>
            <button class="nav-item" onclick="navigateToPage('user-management.html')">
                <i class="fas fa-users"></i>
                <span>User Management</span>
            </button>
            <button class="nav-item" onclick="navigateToPage('contact-management.html')">
                <i class="fas fa-address-book"></i>
                <span>Contact Management</span>
            </button>
            <button class="nav-item" onclick="navigateToPage('broadcast-messaging.html')">
                <i class="fas fa-bullhorn"></i>
                <span>Broadcast Messaging</span>
            </button>
            <button class="nav-item" onclick="navigateToPage('Task-Assign.html')">
                <i class="fas fa-tasks"></i>
                <span>Task Assignment</span>
            </button>
            <button class="nav-item" onclick="navigateToPage('View-Reports.html')">
                <i class="fas fa-file-alt"></i>
                <span>View Reports</span>
            </button>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">Support</div>
            <button class="nav-item active" onclick="navigateToPage('Leads.html')">
                <i class="fas fa-envelope"></i>
                <span>Leads</span>
            </button>
        </div>
    </nav>
</div>

<div class="main-container shifted">
    <h1 class="page-title"><i class="fas fa-filter"></i> Lead Management</h1>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-users"></i></div>
            <div class="stat-number" id="totalLeads">0</div>
            <div class="stat-label">Total Leads</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-user-plus"></i></div>
            <div class="stat-number" id="newLeads">0</div>
            <div class="stat-label">New Today</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-phone"></i></div>
            <div class="stat-number" id="contactedLeads">0</div>
            <div class="stat-label">Contacted</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
            <div class="stat-number" id="conversionRate">0%</div>
            <div class="stat-label">Conversion</div>
        </div>
    </div>

    <div class="card controls-section">
        <div class="controls-grid">
            <div class="control-group">
                <label class="control-label">Search Leads</label>
                <input type="text" class="control-input" id="searchInput" placeholder="Search by name, email, or company...">
            </div>
            <div class="control-group">
                <label class="control-label">Filter by Status</label>
                <select class="control-input" id="statusFilter">
                    <option value="">All Status</option>
                    <option value="new">New</option>
                    <option value="contacted">Contacted</option>
                    <option value="qualified">Qualified</option>
                </select>
            </div>
            <div class="control-group">
                <label class="control-label">Sort by</label>
                <select class="control-input" id="sortFilter">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="name">Name A-Z</option>
                </select>
            </div>
            <div class="control-group">
                <label class="control-label">Actions</label>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="refreshLeads()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="btn btn-secondary" onclick="exportLeads()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="loadingState" class="card" style="text-align: center; padding: 60px 20px;">
        <i class="fas fa-spinner" style="font-size: 32px; animation: spin 1s linear infinite; margin-bottom: 20px;"></i>
        <p>Loading leads...</p>
    </div>

    <div id="tableContainer" class="table-container" style="display: none;">
        <div class="table-wrapper">
            <table>
                <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Status</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="leadsTableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="emptyState" class="card" style="display: none; text-align: center; padding: 60px 20px;">
        <i class="fas fa-inbox" style="font-size: 64px; margin-bottom: 20px;"></i>
        <h3>No leads found</h3>
        <p>No leads match your current filter criteria.</p>
    </div>

    <div id="pagination" class="pagination" style="display: none;"></div>
</div>

<div id="leadDetailModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <h2 id="modalTitle">Lead Details</h2>
        <div id="modalContent"></div>
    </div>
</div>


<script src="js/particles.min.js"></script>
<script src="../config.js"></script>
<script>
    // --- Standard Functions ---
    document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.body.setAttribute('data-theme', savedTheme);
        initParticles(savedTheme);

        const savedSidebarState = localStorage.getItem('sidebarCollapsed');
        const sidebar = document.querySelector('.sidebar');
        const mainContainer = document.querySelector('.main-container');

        if (window.innerWidth <= 768) {
            sidebar.classList.remove('collapsed', 'mobile-active');
            mainContainer.classList.remove('shifted');
        } else {
            if (savedSidebarState === 'true') {
                sidebar.classList.add('collapsed');
                mainContainer.classList.add('shifted');
            } else {
                sidebar.classList.add('collapsed');
                mainContainer.classList.add('shifted');
                localStorage.setItem('sidebarCollapsed', 'true');
            }
        }

        loadLeads();
        setupEventListeners();
        window.addEventListener('resize', handleResize);
    });

    function handleResize() {
        const sidebar = document.querySelector('.sidebar');
        const mainContainer = document.querySelector('.main-container');
        const overlay = document.querySelector('.sidebar-overlay');

        if (window.innerWidth > 768) {
            overlay.classList.remove('active');
            sidebar.classList.remove('mobile-active');
            const savedState = localStorage.getItem('sidebarCollapsed') === 'true';
            if (savedState) {
                sidebar.classList.add('collapsed');
                mainContainer.classList.add('shifted');
            } else {
                sidebar.classList.remove('collapsed');
                mainContainer.classList.remove('shifted');
            }
        } else {
            sidebar.classList.remove('collapsed', 'mobile-active');
            mainContainer.classList.remove('shifted');
            overlay.classList.remove('active');
        }
    }

    function initParticles(theme) {
        if (typeof particlesJS === 'undefined') return;
        if (window.pJSDom && window.pJSDom[0]) {
            window.pJSDom[0].pJS.fn.vendors.destroypJS();
            window.pJSDom = [];
        }
        particlesJS('particles-js', { particles: { number: { value: 80 }, color: { value: "#ffffff" }, shape: { type: "circle" }, opacity: { value: 0.3, random: true }, size: { value: 3, random: true }, line_linked: { enable: true, distance: 150, color: "#ffffff", opacity: 0.2, width: 1 }, move: { enable: true, speed: 3 } }, interactivity: { events: { onhover: { enable: true, mode: "grab" }, onclick: { enable: true, mode: "push" } } } });
    }

    function toggleTheme() {
        const newTheme = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.body.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        initParticles(newTheme);
    }

    function toggleSidebar() {
        const sidebar = document.querySelector('.sidebar');
        const mainContainer = document.querySelector('.main-container');
        const overlay = document.querySelector('.sidebar-overlay');

        if (window.innerWidth <= 768) {
            sidebar.classList.toggle('mobile-active');
            overlay.classList.toggle('active');
        } else {
            sidebar.classList.toggle('collapsed');
            mainContainer.classList.toggle('shifted');
            localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
        }
    }

    function closeMobileSidebar() {
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.querySelector('.sidebar-overlay');
        sidebar.classList.remove('mobile-active');
        overlay.classList.remove('active');
    }

    function logout() { localStorage.clear(); window.location.href = '../index.html'; }
    function navigateToPage(pageName) { window.location.href = pageName; }

    // --- Leads Page Specific Logic ---
    let allLeads = [];
    let filteredLeads = [];
    let currentPage = 1;
    const leadsPerPage = 10;

    function setupEventListeners() {
        document.getElementById('searchInput').addEventListener('input', filterAndDisplayLeads);
        document.getElementById('statusFilter').addEventListener('change', filterAndDisplayLeads);
        document.getElementById('sortFilter').addEventListener('change', filterAndDisplayLeads);
    }

    async function loadLeads() {
        showLoading();
        try {
            const response = await fetch(`${CONTACT_API}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            allLeads = data.map((lead, index) => ({
                ...lead,
                id: lead.id || index + 1,
                status: lead.status || getRandomStatus(),
                createdAt: lead.createdAt || new Date(Date.now() - Math.floor(Math.random() * 30) * 24 * 60 * 60 * 1000).toISOString()
            }));
        } catch (error) {
            console.error('Error loading leads, falling back to empty:', error);
            allLeads = [];
        }
        updateStats();
        filterAndDisplayLeads();
        hideLoading();
    }

    function getRandomStatus() { const statuses = ['new', 'contacted', 'qualified']; return statuses[Math.floor(Math.random() * statuses.length)]; }

    function updateStats() {
        const total = allLeads.length;
        const today = new Date().toISOString().split('T')[0];
        const newToday = allLeads.filter(lead => (lead.createdAt || '').startsWith(today)).length;
        const contacted = allLeads.filter(lead => lead.status === 'contacted').length;
        const qualified = allLeads.filter(lead => lead.status === 'qualified').length;

        document.getElementById('totalLeads').textContent = total;
        document.getElementById('newLeads').textContent = newToday;
        document.getElementById('contactedLeads').textContent = contacted;
        document.getElementById('conversionRate').textContent = (total > 0 ? Math.round((qualified / total) * 100) : 0) + '%';
    }

    function filterAndDisplayLeads() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const status = document.getElementById('statusFilter').value;
        const sort = document.getElementById('sortFilter').value;

        let tempLeads = allLeads.filter(lead => {
            const leadStatus = lead.status ? lead.status.trim().toLowerCase() : '';
            const statusMatch = !status || leadStatus === status;
            const searchMatch = !search ||
                (lead.name && lead.name.toLowerCase().includes(search)) ||
                (lead.email && lead.email.toLowerCase().includes(search)) ||
                (lead.company && lead.company.toLowerCase().includes(search));
            return statusMatch && searchMatch;
        });

        if (sort === 'oldest') {
            tempLeads.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
        } else if (sort === 'name') {
            tempLeads.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        } else {
            tempLeads.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        }

        filteredLeads = tempLeads;
        currentPage = 1;
        displayLeads();
    }

    function displayLeads() {
        const tbody = document.getElementById('leadsTableBody');
        const emptyState = document.getElementById('emptyState');
        const tableContainer = document.getElementById('tableContainer');

        if (filteredLeads.length === 0) {
            tableContainer.style.display = 'none';
            emptyState.style.display = 'block';
            document.getElementById('pagination').style.display = 'none';
            return;
        }

        tableContainer.style.display = 'block';
        emptyState.style.display = 'none';

        const totalPages = Math.ceil(filteredLeads.length / leadsPerPage);
        const pageLeads = filteredLeads.slice((currentPage - 1) * leadsPerPage, currentPage * leadsPerPage);

        tbody.innerHTML = pageLeads.map(lead => `
            <tr>
                <td><strong>${lead.name || 'N/A'}</strong></td>
                <td>${lead.email || 'N/A'}</td>
                <td>${lead.phone || '-'}</td>
                <td><span class="status-badge status-${(lead.status || '').trim().toLowerCase()}">${(lead.status || 'N/A')}</span></td>
                <td>${new Date(lead.createdAt).toLocaleDateString()}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-secondary" onclick="viewLead(${lead.id})"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-primary" onclick="updateLeadStatus(${lead.id}, 'contacted')"><i class="fas fa-phone"></i></button>
                    </div>
                </td>
            </tr>`).join('');

        renderPagination(totalPages);
    }

    function renderPagination(totalPages) {
        const pagination = document.getElementById('pagination');
        if (totalPages <= 1) { pagination.style.display = 'none'; return; }
        pagination.style.display = 'flex';

        const prevBtn = `<button onclick="changePage(currentPage - 1)" ${currentPage === 1 ? 'disabled' : ''}>&laquo;</button>`;
        const nextBtn = `<button onclick="changePage(currentPage + 1)" ${currentPage === totalPages ? 'disabled' : ''}>&raquo;</button>`;
        let pages = '';
        for (let i = 1; i <= totalPages; i++) {
            pages += `<button onclick="changePage(${i})" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
        }
        pagination.innerHTML = prevBtn + pages + nextBtn;
    }

    function changePage(page) { currentPage = page; displayLeads(); }

    function viewLead(leadId) {
        const lead = allLeads.find(l => l.id === leadId);
        if (!lead) return;

        let descriptionHtml = '';
        const descriptionText = lead.problemDescription || lead.description;
        if (descriptionText) {
            descriptionHtml = `<p><strong>Description:</strong> ${descriptionText}</p>`;
        }

        document.getElementById('modalTitle').textContent = `Details for ${lead.name || 'Lead'}`;
        document.getElementById('modalContent').innerHTML = `
            <p><strong>Name:</strong> ${lead.name || 'N/A'}</p>
            <p><strong>Email:</strong> ${lead.email || 'N/A'}</p>
            <p><strong>Phone:</strong> ${lead.phone || 'N/A'}</p>
            <p><strong>Company:</strong> ${lead.company || 'N/A'}</p>
            ${descriptionHtml}
            <p><strong>Status:</strong> <span class="status-badge status-${(lead.status || '').trim().toLowerCase()}">${lead.status}</span></p>
            <p><strong>Date Added:</strong> ${new Date(lead.createdAt).toLocaleString()}</p>
        `;

        document.getElementById('leadDetailModal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('leadDetailModal').classList.remove('active');
    }

    async function updateLeadStatus(leadId, newStatus) {
        const lead = allLeads.find(l => l.id === leadId);
        if (!lead || lead.status === newStatus) return;

        const oldStatus = lead.status;
        lead.status = newStatus;
        filterAndDisplayLeads();
        updateStats();

        try {
            await fetch(`${CONTACT_API}/${leadId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus }),
            });
        } catch (error) {
            console.error('Failed to update lead status:', error);
            lead.status = oldStatus; // Revert on failure
            filterAndDisplayLeads();
            updateStats();
            alert('Failed to update status. Please try again.');
        }
    }

    function refreshLeads() { loadLeads(); }

    function exportLeads() {
        if (filteredLeads.length === 0) { alert('No leads to export.'); return; }
        const headers = ['Name', 'Email', 'Phone', 'Company', 'Status', 'Date Added'];
        const escapeCsvCell = (cell) => {
            const str = String(cell || '');
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return `"${str.replace(/"/g, '""')}"`;
            }
            return str;
        };
        const csvRows = [ headers.join(','), ...filteredLeads.map(lead => [
            escapeCsvCell(lead.name), escapeCsvCell(lead.email), escapeCsvCell(lead.phone),
            escapeCsvCell(lead.company), escapeCsvCell(lead.status), escapeCsvCell(new Date(lead.createdAt).toLocaleString())
        ].join(','))
        ];
        const csvContent = csvRows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.setAttribute('href', URL.createObjectURL(blob));
        link.setAttribute('download', `leads-export-${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function showLoading() { document.getElementById('loadingState').style.display = 'block'; document.getElementById('tableContainer').style.display = 'none'; }
    function hideLoading() { document.getElementById('loadingState').style.display = 'none'; }
</script>

</body>
</html>